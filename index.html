<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>Internal Static Void</title>
    <meta name="author" content="John Doe" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />

    
    <link rel="alternate" href="/atom.xml" title="Internal Static Void" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <style type="text/css">
    @font-face {
        font-family: 'icomoon';
        src: url("/fonts/icomoon.eot?q628ml");
        src: url("/fonts/icomoon.eot?q628ml#iefix") format('embedded-opentype'),
             url("/fonts/icomoon.ttf?q628ml") format('truetype'),
             url("/fonts/icomoon.woff?q628ml") format('woff'),
             url("/fonts/icomoon.svg?q628ml#icomoon") format('svg');
        font-weight: normal;
        font-style: normal;
    }
    </style>
    
<link rel="stylesheet" href="/css/style.css">


    <!--[if lt IE 9]><style type="text/css">.nav-inner {top:0;}.author-meta {position:static;top:0;}.search-form {height:36px;}</style><script type="text/javascript" src="https://unpkg.com/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
<meta name="generator" content="Hexo 5.3.0"></head>
<body>

    <main class="app">
        <header id="header" class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">Internal Static Void</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item active" href="/">
                <span class="nav-text">All</span>
            </a>
        
            <a class="nav-item" href="/categories/azure">
                <span class="nav-text">Azure</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://example.com"></form>

        
        

        
        <div class="author-meta">
            
            <div class="author-avatar">
                <a href="/">
                    <img src="/images/space.PNG" title="Joona Luoma">
                </a>
            </div>
            
            <div class="author-name">Joona Luoma</div>
            <div class="author-work">Developer</div>
            <div class="author-location">
                <i class="icon-location vm"></i>
                <span class="vm">Tampere, Finland</span>
            </div>
            
        </div>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
            <div id="wrapper" class="wrapper" style="max-width: 800px">
                
    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2020/12/28/multitenant-azure-functions/">Multitenant Azure Functions</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://example.com/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2020-12-28T01:53:55.540Z" itemprop="datePublished">2020-12-28</time>
</a>

            

        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>Azure Function runtime provides a smorgasbord of features out-of-box. One of those features isn´t <i>multitenancy</i> (except when talking about clients using Azure AD) but one of those features is <i>Function keys</i>. In this blog post I explore how tenant specific Function keys could be used to enable multitenancy in simple scenarios. Ideally introducing a new tenant - assuming that no customization is required - should be only a question of creating a Function key for said tenant. <em>Disclaimer:</em> In many cases using Function keys is not a sufficient authentication method, and OAuth2 or mutual-auth or at least API Key auth with Azure Vault stored keys should be used instead.</p>
<h2 id="A-new-⚡"><a href="#A-new-⚡" class="headerlink" title="A new ⚡"></a>A new ⚡</h2><p>Here´s a plain Function with an HTTP trigger. For every incoming <code>POST host.com/enqueueV1/&#123;tenantId&#125;?code=&#123;keyValue&#125;</code> request, it enqueues the incoming request body content as string to a tenant specific <code>&#123;tenantId&#125;</code> queue.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">StorageAccount(<span class="meta-string">&quot;AzureWebJobsStorage&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">EnqueueForTenantV1</span></span><br><span class="line">&#123;</span><br><span class="line">  [<span class="meta">FunctionName(<span class="meta-string">&quot;EnqueueForTenantV1&quot;</span>)</span>]</span><br><span class="line">  [<span class="meta">return: Queue(<span class="meta-string">&quot;&#123;tenantId&quot;</span>&#125;)</span>]</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">Run</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    [HttpTrigger(AuthorizationLevel.Function, <span class="string">&quot;POST&quot;</span>, Route = <span class="string">&quot;enqueueV1/&#123;tenantId&#125;&quot;</span></span>)] HttpRequest req</span></span><br><span class="line"><span class="function">  )</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">var</span> reader = <span class="keyword">new</span> StreamReader(req.Body);</span><br><span class="line">    <span class="keyword">return</span> reader.ReadToEndAsync();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now, let´s say that there are two Function keys for this Function. Each key belongs to a unique tenant. We use <code>tenantId</code>s as <code>keyId</code>s:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Tenant    | keyId     | keyValue</span><br><span class="line">----------+-----------+----------</span><br><span class="line">Microsoft | microsoft | bill123</span><br><span class="line">Apple     | apple     | jobs456</span><br></pre></td></tr></table></figure>
<p>As an example, <code>EnqueueForTenantV1</code> allows Apple to do requests like <code>POST host.com/enqueueV1/apple?code=jobs456</code>. The only problem is that the current Function implementation <i>does not forbid access to other tenants´ resources:</i> Apple could also do a request like <code>POST host.com/enqueueV1/microsoft?code=jobs456</code>. Now this is less than optimal 🤔</p>
<h2 id="Checking-what-is-claimed"><a href="#Checking-what-is-claimed" class="headerlink" title="Checking what is claimed"></a>Checking what is claimed</h2><p>Azure Function runtime includes the <code>keyId</code> of the used key <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/62387169/10212522">as a claim</a>. We could just bind the <code>tenantId</code> whose resources are attempted to be accessed and compare that to the claim directly in the function body:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">StorageAccount(<span class="meta-string">&quot;AzureWebJobsStorage&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">EnqueueForTenantV2</span></span><br><span class="line">&#123;</span><br><span class="line">  [<span class="meta">FunctionName(<span class="meta-string">&quot;EnqueueForTenantV2&quot;</span>)</span>]</span><br><span class="line">  [<span class="meta">return: Queue(<span class="meta-string">&quot;&#123;tenantId&quot;</span>&#125;)</span>]</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">Run</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    [HttpTrigger(AuthorizationLevel.Function, <span class="string">&quot;POST&quot;</span>, Route = <span class="string">&quot;enqueueV2/&#123;tenantId&#125;&quot;</span></span>)] HttpRequest req,</span></span><br><span class="line"><span class="function">    <span class="built_in">string</span> tenantId</span></span><br><span class="line"><span class="function">  )</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="keyword">var</span> actualTenantId = req.HttpContext.User.Identities.Single().FindFirst(<span class="string">&quot;http://schemas.microsoft.com/2017/07/functions/claims/keyid&quot;</span>).<span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if attempted tenant id matches the actual tenant id</span></span><br><span class="line">    <span class="keyword">if</span> (tenantId != actualTenantId)</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> UnauthorizedResult();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">var</span> reader = <span class="keyword">new</span> StreamReader(req.Body);</span><br><span class="line">    <span class="keyword">return</span> reader.ReadToEndAsync();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>but this is not very reusable. Preferably all of this would be checked with an attribute of some sort.</p>
<h2 id="Filters-for-Functions"><a href="#Filters-for-Functions" class="headerlink" title="Filters for Functions"></a>Filters for Functions</h2><p>Similar to <code>ActionFilter</code>s in ASP.NET Core, Azure Functions have (currently a preview feature called) <code>FunctionInvocationFilter</code>s. We can create one of our own for tenant authorization purposes and move the aforementioned logic over there:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuthorizeTenantAttribute</span> : <span class="title">FunctionInvocationFilterAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Task <span class="title">OnExecutingAsync</span>(<span class="params">FunctionExecutingContext executingContext, CancellationToken cancellationToken</span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="keyword">var</span> (attemptedTenantId, actualTenantId) = GetTenantIdsSomehow();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if attempted tenant id matches the actual tenant id</span></span><br><span class="line">    <span class="keyword">if</span> (attemptedTenantId != actualTenantId)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedAccessException();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">base</span>.OnExecutingAsync(executingContext, cancellationContext);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>and thus our Function can be reduced to </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">StorageAccount(<span class="meta-string">&quot;AzureWebJobsStorage&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">EnqueueForTenantV2</span></span><br><span class="line">&#123;</span><br><span class="line">  [<span class="meta">FunctionName(<span class="meta-string">&quot;EnqueueForTenantV2&quot;</span>)</span>]</span><br><span class="line">  [<span class="meta">return: Queue(<span class="meta-string">&quot;&#123;tenantId&quot;</span>&#125;)</span>]</span><br><span class="line">  [<span class="meta">AuthorizeTenant</span>]</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">Run</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    [HttpTrigger(AuthorizationLevel.Function, <span class="string">&quot;POST&quot;</span>, Route = <span class="string">&quot;enqueueV2/&#123;tenantId&#125;&quot;</span></span>)] HttpRequest req</span></span><br><span class="line"><span class="function">  )</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">var</span> reader = <span class="keyword">new</span> StreamReader(req.Body);</span><br><span class="line">    <span class="keyword">return</span> reader.ReadToEndAsync();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Unluckily, <code>OnExecutingAsync</code> returns just a <code>Task</code> and there seems to be no way to access <code>HttpContext</code> and set response´s <code>StatusCode</code> inside a <code>FunctionInvocationFilterAttribute</code>. This problem may be due to <code>FunctionInvocationFilterAttribute</code>s being still only a preview feature, but at the same time they have been in preview already for three years, and <a target="_blank" rel="noopener" href="https://github.com/Azure/azure-webjobs-sdk/issues/1284">Microsoft does not <i>seem</i> to be commited to develop this feature any further</a>. Therefore, at least for the time being, the Function will return just <code>HTTP 500</code> in case the attempted and actual <code>tenantId</code>s did not match (due to uncaught <code>UnauthorizedAccessException</code> being thrown in such a scenario).</p>
<p>Another problem is that we should be able to <code>GetTenantIdsSomehow</code>. This, on the contrary, is resolvable 🙂</p>
<h2 id="Getting-tenantIds-somehow"><a href="#Getting-tenantIds-somehow" class="headerlink" title="Getting tenantIds somehow"></a>Getting <code>tenantId</code>s somehow</h2><p><code>AuthorizeTenantAttribute</code>´s <code>OnExecutingAsync</code> has this <code>FunctionExecutingContext executingContext</code> parameter which can be used to access the arguments that <code>EnqueueForTenantV2</code> was invoked with. Therefore, we need to create a <i>custom binding</i> that does all the heavylifting regarding the extraction of <code>tenantId</code>s and then just provides them to <code>AuthorizeTenantAttribute</code> via <code>FunctionExecutingContext executingContext</code>.</p>
<p>In order to bind our desired values to a Function parameter, we need a new <i>parameter</i> for the Function and a <i>binding</i> that sets the parameter value. Off the top of our heads, let´s jut decide that</p>
<ul>
<li>the parameter type is <code>TenantContext</code>, which holds all information related to the tenant that´s currently invoking the Function and</li>
<li>the binding type is <code>Tenancy</code>.</li>
</ul>
<p>Now our Function signature looks like this</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  [<span class="meta">FunctionName(<span class="meta-string">&quot;EnqueueForTenantV2&quot;</span>)</span>]</span><br><span class="line">  [<span class="meta">return: Queue(<span class="meta-string">&quot;&#123;tenantId&quot;</span>&#125;)</span>]</span><br><span class="line">  [<span class="meta">AuthorizeTenant</span>]</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">Run</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    [HttpTrigger(AuthorizationLevel.Function, <span class="string">&quot;POST&quot;</span>, Route = <span class="string">&quot;enqueueV2/&#123;tenantId&#125;&quot;</span></span>)] HttpRequest req,</span></span><br><span class="line"><span class="function">    [<span class="title">Tenancy</span>(<span class="params"><span class="string">&quot;&#123;tenantId&#125;&quot;</span></span>)] TenantContext _</span></span><br><span class="line"><span class="function">  )</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>Tenancy</code> has a single constructor parameter that should be set as <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-expressions-patterns">the binding expression</a> for attempted <code>tenantId</code>, because it can be very situational (Function specific) how it should be extracted from a request. In <code>EnqueueForTenantV2</code>´s case, the attempted <code>tenantId</code> is extracted from the queue name that is attempted to be accessed, so the binding expression is <code>&#123;tenantId&#125;</code>.</p>
<p><code>TenantContext</code> parameter is just discarded with <code>_</code>, because it is not really needed in the Function body. It is just required to be bound and accessible by <code>AuthorizeTenantAttribute</code>. <code>TenantContext</code>´s implementation should be just a lookup POCO:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TenantContext</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">TenantContext</span>(<span class="params"><span class="built_in">string</span> attemptedTenantId, <span class="built_in">string</span> actualTenantId</span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    AttemptedTenantId = attemptedTenantId;</span><br><span class="line">    ActualTenantId = actualTenantId;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">string</span> AttemptedTenantId &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">string</span> ActualTenantId &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now we can get <code>TenantContext</code> and <code>tenantId</code>s in our Function filter:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuthorizeTenantAttribute</span> : <span class="title">FunctionInvocationFilterAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Task <span class="title">OnExecutingAsync</span>(<span class="params">FunctionExecutingContext executingContext, CancellationToken cancellationToken</span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="keyword">var</span> tenantContext = executingContext.Arguments.Single(i =&gt; i.Value <span class="keyword">is</span> TenantContext).Value;</span><br><span class="line">    <span class="keyword">var</span> attemptedTenantId = tenantContext.AttemptedTenantId;</span><br><span class="line">    <span class="keyword">var</span> actualTenantId = tenantContext.ActualTenantId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if attempted tenant id matches the actual tenant id</span></span><br><span class="line">    <span class="keyword">if</span> (attemptedTenantId != actualTenantId)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedAccessException();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">base</span>.OnExecutingAsync(executingContext, cancellationContext);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The last piece to the puzzle is to implement the custom <code>Tenancy</code> binding that brings <code>TenantContext</code> available for <code>AuthorizeTenantAttribute</code>.</p>
<h2 id="The-Binding"><a href="#The-Binding" class="headerlink" title="The Binding"></a>The Binding</h2><p><code>Tenancy</code> binding is essentially <code>TenancyAttribute</code> with parameter usage allowed. It should have a constructor with a parameter for a binding expression for the <i>attempted <code>tenantId</code></i> as was discussed:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Binding</span>]</span><br><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.Parameter)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TenancyAttribute</span> : <span class="title">Attribute</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">TenancyAttribute</span>(<span class="params"><span class="built_in">string</span> attemptedTenantId</span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    AttemptedTenantId = attemptedTenantId;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [<span class="meta">AutoResolve(ResolutionPolicyType = typeof(AttemptedTenantKeyResolutionPolicy))</span>]</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">string</span> AttemptedTenantId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// To be continued...</span></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>In Azure Functions, the values for properties of bound object can be <i>auto-resolved</i> using <code>IResolutionPolicy</code>s. For example, the value for <code>AttemptedTenantId</code> is auto-resolved using <code>AttemptedTenantIdResolutionPolicy</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttemptedTenantIdResolutionPolicy</span> : <span class="title">IResolutionPolicy</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">TemplateBind</span>(<span class="params">PropertyInfo propInfo, Attribute resolvedAttribute, BindingTemplate bindingTemplate, IReadOnlyDictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt; bindingData</span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="keyword">var</span> attemptedTenantId = bindingData[bindingTemplate.ParameterNames.Single()] <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">return</span> attemptedTenantId;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>bindingData</code> contains all key-values that have been resolved so far (including the value for the attempted <code>tenantId</code>, e.g. key-value <code>&quot;tenantId&quot; =&gt; &quot;microsoft&quot;</code>).</p>
<p>On the other hand, <code>bindingTemplate.ParameterNames</code> contains an <code>IEnumerable</code> of the binding expression parameter names associated with the property upon which this <code>AttemptedTenantIdResolutionPolicy</code> is used. In case of <code>TenancyAttribute</code>´s <code>AttemptedTenantId</code>, <code>bindingTemplate.ParameterNames</code> contains only the parameter names in the binding expression that the property has as its value. The property has <code>&quot;&#123;tenantId&#125;&quot;</code>as its value, meaning that the binding expression contains only one parameter name: <code>&quot;tenantId&quot;</code>. Therefore <code>TemplateBind</code> will return the attempted <code>tenantId</code> in the requested path, e.g. <code>&quot;microsoft&quot;</code>.</p>
<h2 id="The-plot-thickens"><a href="#The-plot-thickens" class="headerlink" title="The plot thickens"></a>The plot thickens</h2><p>As required by <code>AuthorizeTenantAttribute</code>, we also need to have the <i>actual <code>tenantId</code></i> in <code>TenantContext</code>. Therefore <code>TenantContext</code> should be like</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Binding</span>]</span><br><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.Parameter)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TenancyAttribute</span> : <span class="title">Attribute</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">TenancyAttribute</span>(<span class="params"><span class="built_in">string</span> attemptedTenantId</span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    AttemptedTenantId = attemptedTenantId;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [<span class="meta">AutoResolve(ResolutionPolicyType = typeof(AttemptedTenantIdResolutionPolicy))</span>]</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">string</span> AttemptedTenantId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">  [<span class="meta">AutoResolve(ResolutionPolicyType = typeof(ActualTenantIdResolutionPolicy))</span>]</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">string</span> ActualTenantId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">&quot;&#123;sys.MethodName&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>…and this contains a <i>slight</i> hack: As discussed, <code>ActualTenantId</code> should be actually extracted from the <code>keyid</code> claim, but the binding expression system of Azure Functions does not support claims (which would be such a good feature). If we left <code>ActualTenantId</code> as <code>null</code>, then <code>ActualTenantIdResolutionPolicy</code> would never be invoked and <code>ActualTenantId</code> would be left <code>null</code>! To make <code>ActualTenantIdResolutionPolicy</code> to be executed, we initialize the property with value <code>&#123;sys.MethodName&#125;</code>. This is just a placeholder and any binding expression could be used instead.</p>
<p>Anyway, <code>ActualTenantIdResolutionPolicy</code> just receives the <code>HttpRequest</code> from <code>bindingData</code> (Azure Functions runtime always binds <code>HttpRequest</code> using the key <code>$request</code> even when it´s not part of the Function signature), gets the actual <code>tenantId</code> from the claim and returns it:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ActualTenantIdResolutionPolicy</span> : <span class="title">IResolutionPolicy</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">TemplateBind</span>(<span class="params">PropertyInfo propInfo, Attribute resolvedAttribute, BindingTemplate bindingTemplate, IReadOnlyDictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt; bindingData</span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="keyword">var</span> req = bindingData[<span class="string">&quot;$request&quot;</span>] <span class="keyword">as</span> HttpRequest;</span><br><span class="line">    <span class="keyword">var</span> actualTenantId = req.HttpContext.User.Identities.Single().FindFirst(<span class="string">&quot;http://schemas.microsoft.com/2017/07/functions/claims/keyid&quot;</span>).<span class="keyword">value</span>;</span><br><span class="line">    <span class="keyword">return</span> actualTenantId;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Implementation-details"><a href="#Implementation-details" class="headerlink" title="Implementation details"></a>Implementation details</h2><p>To make Azure Functions aware of the binding and how <code>TenantContext</code> properties should actually be populated, we need a bit of extra wiring. We have to implement a <code>TenantContextExtension</code> that we can register in <code>Startup.Configure</code> and which actually maps the bound <code>TenancyAttribute</code> properties to <code>TenantContext</code> using a <code>BindingRule</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Extension(nameof(TenantContextExtension))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TenantContextExtension</span> : <span class="title">IExtensionConfigProvider</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Initialize</span>(<span class="params">ExtensionConfigContext context</span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="keyword">var</span> rule = context.AddBindingRule&lt;TenancyAttribute&gt;();</span><br><span class="line">    rule.BindToInput(tenancy =&gt; <span class="keyword">new</span> TenantContext(tenancy.AttemptedTenantId, tenancy.ActualTenantId));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then in <code>Startup.Configure</code> we do:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span> : <span class="title">IWebJobsStartup</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IWebJobsBuilder builder</span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    builder.AddExtension&lt;TenantContextExtension&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And there we have it! Now Apple and Microsoft can no more enqueue to each other’s queues. If the attempted and actual <code>tenantId</code>s do not match, <code>AuthorizeTenantAttribute</code> will throw an exception and the request will be terminated before the Function is invoked.</p>
<h2 id="The-Hindsight"><a href="#The-Hindsight" class="headerlink" title="The Hindsight"></a>The Hindsight</h2><p>Considering that HTTP triggers are the only triggers that external parties would invoke directly, the discussed method should at least trigger-wise be a sufficient solution for Azure Functions multitenancy in scenarios when the Function key system is wanted to be “abused” for both authorization and multitenancy. For example, blob triggers are invoked only indirectly, as <i>either</i> the tenant has no access to the source Storage container <i>or</i> it has a SAS key to that tenant specific container.</p>
<p>Even from the infrastructure point of view, introducing new tenants should really be just a matter of creating and sharing new Function keys. If, for example, a tenant specific queue is missing when <code>EnqueueForTenantV2</code> is invoked, then Azure Function runtime will create the queue. The same will occur also with containers. Thus the infrastructure should - at least for the most part - <i>emerge on demand</i>.</p>
<p>One can also choose a strategy for the tenant keys, as Function keys can allow either <i>Function level</i> or <i>Host level</i> access. If one does not want to provide tenants access to each function separately, then one should use Host keys instead.</p>
<p>In the end this was just an experimentation and is not recommended for production use, because Function keys are not as safe mean of authorization as, for example OAuth2 or mutual certificate authentication.</p>

        
    </section>
</article>






            </div>
        </div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
</footer>

    </main>

    <script type="text/javascript" src="https://unpkg.com/jquery@1.9.1/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }

            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle('normal', slideDone);
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp('normal', slideDone);
            }, 3000);
        }

        function slideDone() {
            if (nodes.navInner.css('display') !== 'none') {
                nodes.navInner.css('display', '');
            }
        }

        $(window).on('resize', function() {
            if ($(this).width() > 960) {
                nodes.navInner.css('display', '');
            }
        });
    });
    </script>
    

</body>
</html>
